(function () {
  const params = new URLSearchParams(window.location.search);
  const clinicName = params.get("clinicName") || "";
  const clinicPhone = params.get("clinicPhone") || "";
  const clientName = params.get("clientName") || "";
  const clientPhone = params.get("clientPhone") || "";
  const clientEmail = params.get("clientEmail") || "";
  const clientSymptoms = params.get("clientSymptoms") || "";
  const userId = params.get("userId") || "";

  const data = {
    clinicName,
    clinicPhone,
    clientName,
    clientPhone,
    clientEmail,
    clientSymptoms,
    userId
  };

  const todayKey = new Date().toISOString().slice(0, 10);
  const counterKey = `call_count_${userId}_${todayKey}`;
  let callCount = parseInt(localStorage.getItem(counterKey) || "0");

  if (callCount >= 3) {
    document.querySelector(".container").innerHTML = `
      <h1>⚠️ 今日撥打次數已達上限</h1>
      <p>您今天已撥打 3 通電話，請明天再試。</p>
    `;
    return;
  }

  // 記錄已撥打，並送 webhook
  fetch("https://sgh.zeabur.app/webhook/891ms", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
    .then(() => {
      console.log("✅ Webhook sent");
      localStorage.setItem(counterKey, (callCount + 1).toString());
    })
    .catch(err => console.error("❌ Webhook error:", err));

  const telLink = `tel:${clinicPhone}`;
  const manualCall = document.getElementById("manualCall");
  manualCall.href = telLink;

  setTimeout(() => {
    window.location.href = telLink;
  }, 2000);
})();